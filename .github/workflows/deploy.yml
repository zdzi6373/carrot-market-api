name: Build and Deploy to OCI

on:
  push:
    branches:
      - develop

env:
  WAR_NAME: carrot-market-api.war

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 소스코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. JDK 17 설정
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 3. 운영환경 db.properties 생성
      - name: Create db.properties
        run: |
          mkdir -p src/main/resources
          cat << EOF > src/main/resources/db.properties
          db.url=${{ secrets.DB_URL }}
          db.username=${{ secrets.DB_USERNAME }}
          db.password=${{ secrets.DB_PASSWORD }}
          db.driver=org.postgresql.Driver
          EOF

      # 4. Maven 빌드
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # 5. WAR 파일 확인
      - name: Verify WAR file
        run: |
          if [ ! -f target/${{ env.WAR_NAME }} ]; then
            echo "WAR file not found!"
            exit 1
          fi
          ls -lh target/${{ env.WAR_NAME }}

      # 6. SSH 키 설정
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.OCI_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.OCI_HOST }} >> ~/.ssh/known_hosts

      # 7. WAR 파일 전송
      - name: Upload WAR to server
        run: |
          scp target/${{ env.WAR_NAME }} \
            ${{ secrets.OCI_USERNAME }}@${{ secrets.OCI_HOST }}:/tmp/${{ env.WAR_NAME }}

      # 8. 배포 스크립트 실행
      - name: Deploy
        run: |
          ssh ${{ secrets.OCI_USERNAME }}@${{ secrets.OCI_HOST }} \
            'bash /opt/tomcat/scripts/deploy.sh'

      # 9. SSH 키 정리
      - name: Cleanup SSH key
        if: always()
        run: rm -rf ~/.ssh/id_rsa
